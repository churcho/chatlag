<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chatlag</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1">
    <link rel="stylesheet" type="text/css" <meta name="viewport"
        content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" />

    <link rel="stylesheet" href="<%= Routes.static_path(@conn, "/css/app.css") %>" />
    <link rel="stylesheet" href="<%= Routes.static_path(@conn, "/style/chat.css") %>" />
</head>
<style>
    .xs {
        font-size: small;
    }
</style>

<body>
    <%= render @view_module, @view_template, assigns %>
    <script type="text/javascript" src="<%= Routes.static_path(@conn, "/js/app.js") %>"></script>
    <script type="text/javascript" src="<%= Routes.static_path(@conn, "/js/jquery-3.4.1.min.js") %>"></script>
    <script>
        jQuery(document).ready(function ($) {
            let $trigger = "";
            let $inImage = false;
            let $image = $("#image_file");

            $("#chatroom-share").click(function (event) {
                event.preventDefault();
                $(".menu_share_popup").toggle()
            });

            $("#camera-id").click(function (event) {
                event.preventDefault();
                $('#media_name').val("")
                $trigger = "start";
                $inImage = true;
                $image.focus()
                $image.click()
            });

            $(".image-close").click(function () {
                $('#image-display').hide()
                $('#video-display').hide()
                $('#media_type').val("")
                $('#media_name').val("")
                $('#media_size').val("")

            })

            $("#image_file").change(function () {

                readURL(this);

            });

            $("#image_file").focusout(function () {

                $trigger = "";

            });
            $("#image_file").focusin(function () {

                if ($trigger == "" && $inImage) {
                    if ($('#media_name').val() == "") {
                        $('#enable-click').click()
                        $inImage = false;
                    }
                }


            });
        })

        function readURL(input) {

            var reader = new FileReader();


            $('#image-display').hide()
            $('#video-display').hide()

            $('#media_name').val(input.files[0].name)
            $('#media_size').val(input.files[0].size)
            $('#media_type').val(input.files[0].type)


            // check for valid type

            $type = $('#media_type').val()
            $size = $('#media_size').val()

            if ($type.includes("image") || $type.includes("video")) {

                if ($size < 10 * 1024000) {
                    reader.onload = function (e) {
                        if ($type.includes("image")) {
                            $('#upload-image-pic').attr('src', e.target.result);
                            $('#image-display').show()
                        } else {
                            $('#upload-video').attr('src', e.target.result);
                            $('#upload-video').attr('type', $type);
                            $('#video-display').show()
                        }
                        // $('#media_content').val(e.target)

                        var fd = new FormData();
                        var files = input.files[0];
                        var csrf = $('input[name="csrf"]').val();
                        fd.append('file', files);
                        fd.append('_csrf_token', csrf);

                        $.ajax({
                            url: '/img_uploads',
                            type: 'post',
                            data: fd,
                            contentType: false,
                            processData: false,
                            success: function (response) {
                            },
                        });

                    }

                    reader.readAsDataURL(input.files[0]);
                } else {
                    if ($type.includes("image")) { $("#upload-image-pic").hide(); $('#image-display').show() }
                    if ($type.includes("video")) { $("#video-tag").hide(); $('#video-display').show() }
                    $(".error-msg").html("קובץ גדול מדי. לא ניתן להציג")
                    $(".error-msg").show()
                    $('#media_type').val("")
                    $('#media_name').val("")
                    $('#media_size').val("")
                }
            } else {
                $('#media_name').val("")
                $('#media_size').val("")
                $('#media_type').val("")

                $('#upload-image-pic').attr('src', '');

            }
            $inImage = false;
        }
        function startUpload(formData) {

            jQuery.ajax({
                type: 'POST',
                url: '/img_uploads',

                data: formData,
                processData: true, //IMPORTANT!

                cache: false,
                contentType: false,



                success: function (data) {
                    console.log("SUCCESS", data)
                },

                error: function (data) {
                    console.error(data);
                }
            })
        }
    </script>
</body>

</html>